// Application State
let currentData = {
    items: [],
    centers: [],
    incoming: [],
    donations: [],
    outgoing: [],
    incomingBills: [],
    donationBills: [],
    outgoingBills: [],
    currentStock: [],
    lowStock: []
};

// Initialize App
document.addEventListener('DOMContentLoaded', () => {
    initializeNavigation();
    initializeSidebar();
    initializeEventListeners();
    loadDashboard();
});

// Navigation
function initializeNavigation() {
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
        item.addEventListener('click', () => {
            const pageName = item.getAttribute('data-page');
            switchPage(pageName);
        });
    });
}

// Sidebar Toggle
function initializeSidebar() {
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const hamburgerBtn = document.getElementById('hamburgerBtn');

    // Toggle sidebar collapse
    sidebarToggle.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
    });

    // Hamburger menu to expand sidebar
    hamburgerBtn.addEventListener('click', () => {
        sidebar.classList.remove('collapsed');
        localStorage.setItem('sidebarCollapsed', 'false');
    });

    // Restore sidebar state
    const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    if (isCollapsed) {
        sidebar.classList.add('collapsed');
    }
}

function switchPage(pageName) {
    // Update navigation
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-page="${pageName}"]`).classList.add('active');

    // Update pages
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
    });
    document.getElementById(`${pageName}-page`).classList.add('active');

    // Update title
    const titles = {
        'dashboard': 'Dashboard',
        'current-stock': 'Current Stock',
        'incoming': 'Incoming Stock',
        'donations': 'Donations',
        'outgoing': 'Dispatch/Outgoing Stock',
        'items': 'Items Master',
        'centers': 'Centers Master',
        'reports': 'Reports',
        'settings': 'Settings'
    };
    document.getElementById('page-title').textContent = titles[pageName];

    // Load page data
    loadPageData(pageName);
}

function loadPageData(pageName) {
    switch(pageName) {
        case 'dashboard':
            loadDashboard();
            break;
        case 'current-stock':
            loadCurrentStock();
            break;
        case 'incoming':
            loadIncomingStock();
            break;
        case 'donations':
            loadDonations();
            break;
        case 'reports':
            loadReportsPage();
            break;
        case 'outgoing':
            loadOutgoingStock();
            break;
        case 'items':
            loadItems();
            break;
        case 'centers':
            loadCenters();
            break;
    }
}

// Event Listeners
function initializeEventListeners() {
    // Refresh button
    document.getElementById('refreshBtn').addEventListener('click', () => {
        const activePage = document.querySelector('.nav-item.active').getAttribute('data-page');
        loadPageData(activePage);
        showNotification('Data refreshed successfully', 'success');
    });

    // Items
    document.getElementById('addItemBtn').addEventListener('click', showAddItemModal);

    // Centers
    document.getElementById('addCenterBtn').addEventListener('click', showAddCenterModal);

    // Incoming Stock Bills
    document.getElementById('addIncomingBillBtn').addEventListener('click', showAddIncomingBillModal);

    // Donation Bills
    document.getElementById('addDonationBillBtn').addEventListener('click', showAddDonationBillModal);

    // Outgoing Stock Bills
    document.getElementById('addOutgoingBillBtn').addEventListener('click', showAddOutgoingBillModal);

    // Settings
    document.getElementById('exportDbBtn').addEventListener('click', exportDatabase);
    document.getElementById('importDbBtn').addEventListener('click', importDatabase);

    // Modal close
    document.querySelector('.close').addEventListener('click', closeModal);
    document.getElementById('modal').addEventListener('click', (e) => {
        if (e.target.id === 'modal') closeModal();
    });

    // Stock search
    document.getElementById('stock-search').addEventListener('input', filterStockTable);
}

// Dashboard Functions
async function loadDashboard() {
    try {
        const [items, centers, incoming, donations, outgoing, stock, lowStock] = await Promise.all([
            window.api.items.getActive(),
            window.api.centers.getActive(),
            window.api.incoming.getAll(),
            window.api.donations.getAll(),
            window.api.outgoing.getAll(),
            window.api.stock.getCurrent(),
            window.api.stock.getLowStock()
        ]);

        currentData = { items, centers, incoming, donations, outgoing, currentStock: stock, lowStock };

        // Update stats
        document.getElementById('total-items').textContent = items.length;
        document.getElementById('low-stock-count').textContent = lowStock.length;
        document.getElementById('total-centers').textContent = centers.length;
        document.getElementById('total-transactions').textContent = 
            incoming.length + donations.length + outgoing.length;

        // Update low stock table
        renderLowStockTable(lowStock);
    } catch (error) {
        console.error('Error loading dashboard:', error);
        showNotification('Failed to load dashboard data', 'error');
    }
}

function renderLowStockTable(data) {
    const tbody = document.querySelector('#low-stock-table tbody');
    tbody.innerHTML = '';

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">No low stock items</td></tr>';
        return;
    }

    data.forEach(item => {
        const row = `
            <tr>
                <td>${escapeHtml(item.Item_Name)}</td>
                <td>${escapeHtml(item.Category)}</td>
                <td><strong>${item.Current_Quantity}</strong></td>
                <td>${item.Reorder_Level}</td>
                <td>${escapeHtml(item.Unit_Measure)}</td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

// Current Stock Functions
async function loadCurrentStock() {
    try {
        const stock = await window.api.stock.getCurrent();
        currentData.currentStock = stock;
        renderCurrentStockTable(stock);
    } catch (error) {
        console.error('Error loading current stock:', error);
        showNotification('Failed to load current stock', 'error');
    }
}

function renderCurrentStockTable(data) {
    const tbody = document.querySelector('#current-stock-table tbody');
    tbody.innerHTML = '';

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No stock data available</td></tr>';
        return;
    }

    data.forEach(item => {
        const statusClass = item.Stock_Status === 'Low Stock' ? 'status-low' : 'status-ok';
        const row = `
            <tr>
                <td>${item.Item_ID}</td>
                <td>${escapeHtml(item.Item_Name)}</td>
                <td>${escapeHtml(item.Category)}</td>
                <td><strong>${item.Current_Quantity}</strong></td>
                <td>${escapeHtml(item.Unit_Measure)}</td>
                <td>${item.Reorder_Level}</td>
                <td><span class="status-badge ${statusClass}">${item.Stock_Status}</span></td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function filterStockTable() {
    const searchTerm = document.getElementById('stock-search').value.toLowerCase();
    const filtered = currentData.currentStock.filter(item =>
        item.Item_Name.toLowerCase().includes(searchTerm) ||
        item.Category.toLowerCase().includes(searchTerm)
    );
    renderCurrentStockTable(filtered);
}

// Items Functions
async function loadItems() {
    try {
        const items = await window.api.items.getAll();
        currentData.items = items;
        renderItemsTable(items);
    } catch (error) {
        console.error('Error loading items:', error);
        showNotification('Failed to load items', 'error');
    }
}

function renderItemsTable(data) {
    const tbody = document.querySelector('#items-table tbody');
    tbody.innerHTML = '';

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No items found</td></tr>';
        return;
    }

    data.forEach(item => {
        const statusClass = item.Status === 'Active' ? 'status-active' : 'status-inactive';
        const row = `
            <tr>
                <td>${item.Item_ID}</td>
                <td>${escapeHtml(item.Item_Name)}</td>
                <td>${escapeHtml(item.Unit_Measure)}</td>
                <td>${escapeHtml(item.Category)}</td>
                <td>${item.Reorder_Level}</td>
                <td><span class="status-badge ${statusClass}">${item.Status}</span></td>
                <td>
                    <button class="btn btn-small btn-secondary" onclick="editItem(${item.Item_ID})">Edit</button>
                    ${item.Status === 'Active' ? 
                        `<button class="btn btn-small btn-danger" onclick="deleteItem(${item.Item_ID})">Delete</button>` : ''}
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function showAddItemModal() {
    const modalBody = `
        <form id="itemForm">
            <div class="form-group">
                <label>Item Name *</label>
                <input type="text" id="itemName" required>
            </div>
            <div class="form-group">
                <label>Unit of Measure *</label>
                <input type="text" id="unitMeasure" placeholder="e.g., KG, Liter, Pieces" required>
            </div>
            <div class="form-group">
                <label>Category *</label>
                <input type="text" id="category" placeholder="e.g., Food, Medical, Clothing" required>
            </div>
            <div class="form-group">
                <label>Reorder Level</label>
                <input type="number" id="reorderLevel" value="0" min="0">
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Item</button>
            </div>
        </form>
    `;

    showModal('Add New Item', modalBody);

    document.getElementById('itemForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            await window.api.items.add({
                Item_Name: document.getElementById('itemName').value,
                Unit_Measure: document.getElementById('unitMeasure').value,
                Category: document.getElementById('category').value,
                Reorder_Level: parseInt(document.getElementById('reorderLevel').value)
            });
            closeModal();
            loadItems();
            showNotification('Item added successfully', 'success');
        } catch (error) {
            showNotification('Failed to add item: ' + error.message, 'error');
        }
    });
}

async function editItem(itemId) {
    const item = currentData.items.find(i => i.Item_ID === itemId);
    if (!item) return;

    const modalBody = `
        <form id="itemForm">
            <div class="form-group">
                <label>Item Name *</label>
                <input type="text" id="itemName" value="${escapeHtml(item.Item_Name)}" required>
            </div>
            <div class="form-group">
                <label>Unit of Measure *</label>
                <input type="text" id="unitMeasure" value="${escapeHtml(item.Unit_Measure)}" required>
            </div>
            <div class="form-group">
                <label>Category *</label>
                <input type="text" id="category" value="${escapeHtml(item.Category)}" required>
            </div>
            <div class="form-group">
                <label>Reorder Level</label>
                <input type="number" id="reorderLevel" value="${item.Reorder_Level}" min="0">
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Item</button>
            </div>
        </form>
    `;

    showModal('Edit Item', modalBody);

    document.getElementById('itemForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            await window.api.items.update(itemId, {
                Item_Name: document.getElementById('itemName').value,
                Unit_Measure: document.getElementById('unitMeasure').value,
                Category: document.getElementById('category').value,
                Reorder_Level: parseInt(document.getElementById('reorderLevel').value)
            });
            closeModal();
            loadItems();
            showNotification('Item updated successfully', 'success');
        } catch (error) {
            showNotification('Failed to update item: ' + error.message, 'error');
        }
    });
}

async function deleteItem(itemId) {
    if (!confirm('Are you sure you want to delete this item?')) return;

    try {
        await window.api.items.delete(itemId);
        loadItems();
        showNotification('Item deleted successfully', 'success');
    } catch (error) {
        showNotification('Failed to delete item: ' + error.message, 'error');
    }
}

// Centers Functions
async function loadCenters() {
    try {
        const centers = await window.api.centers.getAll();
        currentData.centers = centers;
        renderCentersTable(centers);
    } catch (error) {
        console.error('Error loading centers:', error);
        showNotification('Failed to load centers', 'error');
    }
}

function renderCentersTable(data) {
    const tbody = document.querySelector('#centers-table tbody');
    tbody.innerHTML = '';

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No centers found</td></tr>';
        return;
    }

    data.forEach(center => {
        const statusClass = center.Status === 'Active' ? 'status-active' : 'status-inactive';
        const row = `
            <tr>
                <td>${center.Center_ID}</td>
                <td>${escapeHtml(center.Center_Name)}</td>
                <td>${escapeHtml(center.District)}</td>
                <td>${escapeHtml(center.Contact_Person || '-')}</td>
                <td>${escapeHtml(center.Contact_Phone || '-')}</td>
                <td><span class="status-badge ${statusClass}">${center.Status}</span></td>
                <td>
                    <button class="btn btn-small btn-secondary" onclick="editCenter(${center.Center_ID})">Edit</button>
                    ${center.Status === 'Active' ? 
                        `<button class="btn btn-small btn-danger" onclick="deleteCenter(${center.Center_ID})">Delete</button>` : ''}
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function showAddCenterModal() {
    const modalBody = `
        <form id="centerForm">
            <div class="form-group">
                <label>Center Name *</label>
                <input type="text" id="centerName" required>
            </div>
            <div class="form-group">
                <label>District *</label>
                <input type="text" id="district" required>
            </div>
            <div class="form-group">
                <label>Contact Person</label>
                <input type="text" id="contactPerson">
            </div>
            <div class="form-group">
                <label>Contact Phone</label>
                <input type="text" id="contactPhone">
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Center</button>
            </div>
        </form>
    `;

    showModal('Add New Center', modalBody);

    document.getElementById('centerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            await window.api.centers.add({
                Center_Name: document.getElementById('centerName').value,
                District: document.getElementById('district').value,
                Contact_Person: document.getElementById('contactPerson').value || null,
                Contact_Phone: document.getElementById('contactPhone').value || null
            });
            closeModal();
            loadCenters();
            showNotification('Center added successfully', 'success');
        } catch (error) {
            showNotification('Failed to add center: ' + error.message, 'error');
        }
    });
}

async function editCenter(centerId) {
    const center = currentData.centers.find(c => c.Center_ID === centerId);
    if (!center) return;

    const modalBody = `
        <form id="centerForm">
            <div class="form-group">
                <label>Center Name *</label>
                <input type="text" id="centerName" value="${escapeHtml(center.Center_Name)}" required>
            </div>
            <div class="form-group">
                <label>District *</label>
                <input type="text" id="district" value="${escapeHtml(center.District)}" required>
            </div>
            <div class="form-group">
                <label>Contact Person</label>
                <input type="text" id="contactPerson" value="${escapeHtml(center.Contact_Person || '')}">
            </div>
            <div class="form-group">
                <label>Contact Phone</label>
                <input type="text" id="contactPhone" value="${escapeHtml(center.Contact_Phone || '')}">
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Center</button>
            </div>
        </form>
    `;

    showModal('Edit Center', modalBody);

    document.getElementById('centerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
            await window.api.centers.update(centerId, {
                Center_Name: document.getElementById('centerName').value,
                District: document.getElementById('district').value,
                Contact_Person: document.getElementById('contactPerson').value || null,
                Contact_Phone: document.getElementById('contactPhone').value || null
            });
            closeModal();
            loadCenters();
            showNotification('Center updated successfully', 'success');
        } catch (error) {
            showNotification('Failed to update center: ' + error.message, 'error');
        }
    });
}

async function deleteCenter(centerId) {
    if (!confirm('Are you sure you want to delete this center?')) return;

    try {
        await window.api.centers.delete(centerId);
        loadCenters();
        showNotification('Center deleted successfully', 'success');
    } catch (error) {
        showNotification('Failed to delete center: ' + error.message, 'error');
    }
}

// Incoming Stock Functions
// ==================== INCOMING STOCK BILLS ====================

async function loadIncomingStock() {
    try {
        const bills = await window.api.incoming.bills.getAll();
        currentData.incomingBills = bills;
        renderIncomingBillsTable(bills);
    } catch (error) {
        console.error('Error loading incoming bills:', error);
        showNotification('Failed to load incoming bills', 'error');
    }
}

function renderIncomingBillsTable(data) {
    const tbody = document.querySelector('#incoming-bills-table tbody');
    tbody.innerHTML = '';

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No incoming bills found</td></tr>';
        return;
    }

    data.forEach(bill => {
        const row = `
            <tr>
                <td><strong>${escapeHtml(bill.Bill_Number || 'N/A')}</strong></td>
                <td>${formatDate(bill.Date_Received)}</td>
                <td>${escapeHtml(bill.Supplier_Name)}</td>
                <td><span class="badge">${bill.Item_Count || 0} items</span></td>
                <td><strong>${bill.Total_Quantity || 0}</strong></td>
                <td>${escapeHtml(bill.Remarks || '-')}</td>
                <td class="actions">
                    <button class="btn-icon btn-view" onclick="viewIncomingBillDetails(${bill.Bill_ID})" title="View">üëÅÔ∏è</button>
                    <button class="btn-icon btn-edit" onclick="showEditIncomingBillModal(${bill.Bill_ID})" title="Edit">‚úèÔ∏è</button>
                    <button class="btn-icon btn-delete" onclick="deleteIncomingBill(${bill.Bill_ID})" title="Delete">üóëÔ∏è</button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function showAddIncomingModal() {
    const modalBody = `
        <form id="incomingForm">
            <div class="form-group">
                <label>Date Received *</label>
                <input type="date" id="dateReceived" value="${getCurrentDate()}" required>
            </div>
            <div class="form-group">
                <label>Item *</label>
                <div id="itemIdContainer"></div>
            </div>
            <div class="form-group">
                <label>Supplier Name *</label>
                <input type="text" id="supplierName" required>
            </div>
            <div class="form-group">
                <label>Quantity Received *</label>
                <input type="number" id="qtyReceived" min="1" required>
            </div>
            <div class="form-group">
                <label>Remarks</label>
                <textarea id="remarks"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Record</button>
            </div>
        </form>
    `;

    showModal('Add Incoming Stock', modalBody);

    // Load items if not already loaded
    const loadItemsPromise = currentData.items.length === 0 ? 
        window.api.items.getActive().then(items => { currentData.items = items; }) : 
        Promise.resolve();

    loadItemsPromise.then(() => {
        const itemOptions = currentData.items
            .filter(i => i.Status === 'Active')
            .map(i => ({ 
                value: i.Item_ID.toString(), 
                text: `${i.Item_Name} (${i.Unit_Measure})` 
            }));

        const itemSelect = new SearchableSelect('itemIdContainer', itemOptions, 'Search items...');
        window.currentItemSelect = itemSelect;
    });

    document.getElementById('incomingForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const itemId = window.currentItemSelect ? window.currentItemSelect.getValue() : '';
        if (!itemId) {
            showNotification('Please select an item', 'error');
            return;
        }
        try {
            await window.api.incoming.add({
                Date_Received: document.getElementById('dateReceived').value,
                Item_ID: parseInt(itemId),
                Supplier_Name: document.getElementById('supplierName').value,
                Qty_Received: parseInt(document.getElementById('qtyReceived').value),
                Remarks: document.getElementById('remarks').value || null
            });
            closeModal();
            loadIncomingStock();
            showNotification('Incoming stock added successfully', 'success');
        } catch (error) {
            showNotification('Failed to add incoming stock: ' + error.message, 'error');
        }
    });
}

function showEditIncomingModal(grnId) {
    const stock = currentData.incoming.find(s => s.GRN_ID === grnId);
    if (!stock) {
        showNotification('Record not found', 'error');
        return;
    }

    const modalBody = `
        <form id="editIncomingForm">
            <div class="form-group">
                <label>Date Received *</label>
                <input type="date" id="dateReceived" value="${stock.Date_Received.split('T')[0]}" required>
            </div>
            <div class="form-group">
                <label>Item *</label>
                <div id="itemIdContainer"></div>
            </div>
            <div class="form-group">
                <label>Supplier Name *</label>
                <input type="text" id="supplierName" value="${escapeHtml(stock.Supplier_Name)}" required>
            </div>
            <div class="form-group">
                <label>Quantity Received *</label>
                <input type="number" id="qtyReceived" value="${stock.Qty_Received}" min="1" required>
            </div>
            <div class="form-group">
                <label>Remarks</label>
                <textarea id="remarks">${escapeHtml(stock.Remarks || '')}</textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Record</button>
            </div>
        </form>
    `;

    showModal('Edit Incoming Stock', modalBody);

    // Load all items for editing (not just active ones)
    window.api.items.getAll().then(items => {
        const itemOptions = items.map(i => ({ 
            value: i.Item_ID.toString(), 
            text: `${i.Item_Name} (${i.Unit_Measure})${i.Status === 'Inactive' ? ' [Inactive]' : ''}` 
        }));

        const itemSelect = new SearchableSelect('itemIdContainer', itemOptions, 'Search items...');
        itemSelect.setValue(stock.Item_ID.toString());
        window.currentItemSelect = itemSelect;
    });

    document.getElementById('editIncomingForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const itemId = window.currentItemSelect ? window.currentItemSelect.getValue() : '';
        if (!itemId) {
            showNotification('Please select an item', 'error');
            return;
        }
        try {
            await window.api.incoming.update(grnId, {
                Date_Received: document.getElementById('dateReceived').value,
                Item_ID: parseInt(itemId),
                Supplier_Name: document.getElementById('supplierName').value,
                Qty_Received: parseInt(document.getElementById('qtyReceived').value),
                Remarks: document.getElementById('remarks').value || null
            });
            closeModal();
            loadIncomingStock();
            showNotification('Incoming stock updated successfully', 'success');
        } catch (error) {
            showNotification('Failed to update incoming stock: ' + error.message, 'error');
        }
    });
}

async function deleteIncomingStock(grnId) {
    if (!confirm('Are you sure you want to delete this incoming stock record?')) {
        return;
    }
    try {
        await window.api.incoming.delete(grnId);
        loadIncomingStock();
        showNotification('Incoming stock deleted successfully', 'success');
    } catch (error) {
        showNotification('Failed to delete incoming stock: ' + error.message, 'error');
    }
}

// ==================== DONATIONS & OUTGOING - Handled by bill-functions.js ====================
// All donation and outgoing stock functions are now in bill-functions.js
// This includes:
// - loadDonations(), loadOutgoingStock()
// - All modal and CRUD operations for donations and outgoing bills

// Database Import/Export
    tbody.innerHTML = '';

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">No donation records</td></tr>';
        return;
    }

    data.forEach(donation => {
        const row = `
            <tr>
                <td>${donation.Donation_ID}</td>
                <td>${formatDate(donation.Date_Received)}</td>
                <td>${escapeHtml(donation.Item_Name)}</td>
                <td>${escapeHtml(donation.Donor_Name)}</td>
                <td><strong>${donation.Qty_Received}</strong></td>
                <td>${escapeHtml(donation.Unit_Measure)}</td>
                <td>${escapeHtml(donation.Remarks || '-')}</td>
                <td class="actions">
                    <button class="btn-icon btn-edit" onclick="showEditDonationModal(${donation.Donation_ID})" title="Edit">‚úèÔ∏è</button>
                    <button class="btn-icon btn-delete" onclick="deleteDonation(${donation.Donation_ID})" title="Delete">üóëÔ∏è</button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function showAddDonationModal() {
    const modalBody = `
        <form id="donationForm">
            <div class="form-group">
                <label>Date Received *</label>
                <input type="date" id="dateReceived" value="${getCurrentDate()}" required>
            </div>
            <div class="form-group">
                <label>Item *</label>
                <div id="donationItemIdContainer"></div>
            </div>
            <div class="form-group">
                <label>Donor Name *</label>
                <input type="text" id="donorName" required>
            </div>
            <div class="form-group">
                <label>Quantity Received *</label>
                <input type="number" id="qtyReceived" min="1" required>
            </div>
            <div class="form-group">
                <label>Remarks</label>
                <textarea id="remarks"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Donation</button>
            </div>
        </form>
    `;

    showModal('Add Donation Record', modalBody);

    // Load items if not already loaded
    const loadItemsPromise = currentData.items.length === 0 ? 
        window.api.items.getActive().then(items => { currentData.items = items; }) : 
        Promise.resolve();

    loadItemsPromise.then(() => {
        const itemOptions = currentData.items
            .filter(i => i.Status === 'Active')
            .map(i => ({ 
                value: i.Item_ID.toString(), 
                text: `${i.Item_Name} (${i.Unit_Measure})` 
            }));

        const itemSelect = new SearchableSelect('donationItemIdContainer', itemOptions, 'Search items...');
        window.currentDonationItemSelect = itemSelect;
    });

    document.getElementById('donationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const itemId = window.currentDonationItemSelect ? window.currentDonationItemSelect.getValue() : '';
        if (!itemId) {
            showNotification('Please select an item', 'error');
            return;
        }
        try {
            await window.api.donations.add({
                Date_Received: document.getElementById('dateReceived').value,
                Item_ID: parseInt(itemId),
                Donor_Name: document.getElementById('donorName').value,
                Qty_Received: parseInt(document.getElementById('qtyReceived').value),
                Remarks: document.getElementById('remarks').value || null
            });
            closeModal();
            loadDonations();
            showNotification('Donation added successfully', 'success');
        } catch (error) {
            showNotification('Failed to add donation: ' + error.message, 'error');
        }
    });
}

function showEditDonationModal(donationId) {
    const donation = currentData.donations.find(d => d.Donation_ID === donationId);
    if (!donation) {
        showNotification('Record not found', 'error');
        return;
    }

    const modalBody = `
        <form id="editDonationForm">
            <div class="form-group">
                <label>Date Received *</label>
                <input type="date" id="dateReceived" value="${donation.Date_Received.split('T')[0]}" required>
            </div>
            <div class="form-group">
                <label>Item *</label>
                <div id="donationItemIdContainer"></div>
            </div>
            <div class="form-group">
                <label>Donor Name *</label>
                <input type="text" id="donorName" value="${escapeHtml(donation.Donor_Name)}" required>
            </div>
            <div class="form-group">
                <label>Quantity Received *</label>
                <input type="number" id="qtyReceived" value="${donation.Qty_Received}" min="1" required>
            </div>
            <div class="form-group">
                <label>Remarks</label>
                <textarea id="remarks">${escapeHtml(donation.Remarks || '')}</textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Donation</button>
            </div>
        </form>
    `;

    showModal('Edit Donation Record', modalBody);

    // Load all items for editing (not just active ones)
    window.api.items.getAll().then(items => {
        const itemOptions = items.map(i => ({ 
            value: i.Item_ID.toString(), 
            text: `${i.Item_Name} (${i.Unit_Measure})${i.Status === 'Inactive' ? ' [Inactive]' : ''}` 
        }));

        const itemSelect = new SearchableSelect('donationItemIdContainer', itemOptions, 'Search items...');
        itemSelect.setValue(donation.Item_ID.toString());
        window.currentDonationItemSelect = itemSelect;
    });

    document.getElementById('editDonationForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const itemId = window.currentDonationItemSelect ? window.currentDonationItemSelect.getValue() : '';
        if (!itemId) {
            showNotification('Please select an item', 'error');
            return;
        }
        try {
            await window.api.donations.update(donationId, {
                Date_Received: document.getElementById('dateReceived').value,
                Item_ID: parseInt(itemId),
                Donor_Name: document.getElementById('donorName').value,
                Qty_Received: parseInt(document.getElementById('qtyReceived').value),
                Remarks: document.getElementById('remarks').value || null
            });
            closeModal();
            loadDonations();
            showNotification('Donation updated successfully', 'success');
        } catch (error) {
            showNotification('Failed to update donation: ' + error.message, 'error');
        }
    });
}

async function deleteDonation(donationId) {
    if (!confirm('Are you sure you want to delete this donation record?')) {
        return;
    }
    try {
        await window.api.donations.delete(donationId);
        loadDonations();
        showNotification('Donation deleted successfully', 'success');
    } catch (error) {
        showNotification('Failed to delete donation: ' + error.message, 'error');
    }
}

// Outgoing Stock Functions
async function loadOutgoingStock() {
    try {
        const outgoing = await window.api.outgoing.getAll();
        currentData.outgoing = outgoing;
        renderOutgoingTable(outgoing);
    } catch (error) {
        console.error('Error loading outgoing stock:', error);
        showNotification('Failed to load outgoing stock', 'error');
    }
}

function renderOutgoingTable(data) {
    const tbody = document.querySelector('#outgoing-table tbody');
    tbody.innerHTML = '';

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center">No dispatch records</td></tr>';
        return;
    }

    data.forEach(stock => {
        const row = `
            <tr>
                <td>${stock.Dispatch_ID}</td>
                <td>${formatDate(stock.Date_Issued)}</td>
                <td>${escapeHtml(stock.Center_Name)} - ${escapeHtml(stock.District)}</td>
                <td>${escapeHtml(stock.Item_Name)}</td>
                <td>${stock.Qty_Requested}</td>
                <td><strong>${stock.Qty_Issued}</strong></td>
                <td>${escapeHtml(stock.Officer_Name)}</td>
                <td>${escapeHtml(stock.Officer_NIC)}</td>
                <td class="actions">
                    <button class="btn-icon btn-edit" onclick="showEditOutgoingModal(${stock.Dispatch_ID})" title="Edit">‚úèÔ∏è</button>
                    <button class="btn-icon btn-delete" onclick="deleteOutgoingStock(${stock.Dispatch_ID})" title="Delete">üóëÔ∏è</button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function showAddOutgoingModal() {
    const modalBody = `
        <form id="outgoingForm">
            <div class="form-group">
                <label>Date Issued *</label>
                <input type="date" id="dateIssued" value="${getCurrentDate()}" required>
            </div>
            <div class="form-group">
                <label>Center *</label>
                <div id="centerIdContainer"></div>
            </div>
            <div class="form-group">
                <label>Item *</label>
                <div id="outgoingItemIdContainer"></div>
            </div>
            <div class="form-group">
                <label>Quantity Requested *</label>
                <input type="number" id="qtyRequested" min="1" required>
            </div>
            <div class="form-group">
                <label>Quantity Issued *</label>
                <input type="number" id="qtyIssued" min="0" required>
            </div>
            <div class="form-group">
                <label>Officer Name *</label>
                <input type="text" id="officerName" required>
            </div>
            <div class="form-group">
                <label>Officer NIC *</label>
                <input type="text" id="officerNIC" required>
            </div>
            <div class="form-group">
                <label>Remarks</label>
                <textarea id="remarks"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Dispatch Stock</button>
            </div>
        </form>
    `;

    showModal('Dispatch Stock', modalBody);

    // Load items and centers if not already loaded
    const loadPromise = (currentData.items.length === 0 || currentData.centers.length === 0) ?
        Promise.all([
            window.api.items.getActive(),
            window.api.centers.getActive()
        ]).then(([items, centers]) => {
            currentData.items = items;
            currentData.centers = centers;
        }) : Promise.resolve();

    loadPromise.then(() => {
        const itemOptions = currentData.items
            .filter(i => i.Status === 'Active')
            .map(i => ({ 
                value: i.Item_ID.toString(), 
                text: `${i.Item_Name} (${i.Unit_Measure})` 
            }));

        const centerOptions = currentData.centers
            .filter(c => c.Status === 'Active')
            .map(c => ({ 
                value: c.Center_ID.toString(), 
                text: `${c.Center_Name} - ${c.District}` 
            }));

        const itemSelect = new SearchableSelect('outgoingItemIdContainer', itemOptions, 'Search items...');
        const centerSelect = new SearchableSelect('centerIdContainer', centerOptions, 'Search centers...');
        
        window.currentOutgoingItemSelect = itemSelect;
        window.currentCenterSelect = centerSelect;
    });

    document.getElementById('outgoingForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const itemId = window.currentOutgoingItemSelect ? window.currentOutgoingItemSelect.getValue() : '';
        const centerId = window.currentCenterSelect ? window.currentCenterSelect.getValue() : '';
        
        if (!itemId) {
            showNotification('Please select an item', 'error');
            return;
        }
        if (!centerId) {
            showNotification('Please select a center', 'error');
            return;
        }
        
        try {
            await window.api.outgoing.add({
                Date_Issued: document.getElementById('dateIssued').value,
                Center_ID: parseInt(centerId),
                Item_ID: parseInt(itemId),
                Qty_Requested: parseInt(document.getElementById('qtyRequested').value),
                Qty_Issued: parseInt(document.getElementById('qtyIssued').value),
                Officer_Name: document.getElementById('officerName').value,
                Officer_NIC: document.getElementById('officerNIC').value,
                Remarks: document.getElementById('remarks').value || null
            });
            closeModal();
            loadOutgoingStock();
            showNotification('Stock dispatched successfully', 'success');
        } catch (error) {
            showNotification('Failed to dispatch stock: ' + error.message, 'error');
        }
    });
}

function showEditOutgoingModal(dispatchId) {
    const stock = currentData.outgoing.find(s => s.Dispatch_ID === dispatchId);
    if (!stock) {
        showNotification('Record not found', 'error');
        return;
    }

    const modalBody = `
        <form id="editOutgoingForm">
            <div class="form-group">
                <label>Date Issued *</label>
                <input type="date" id="dateIssued" value="${stock.Date_Issued.split('T')[0]}" required>
            </div>
            <div class="form-group">
                <label>Center *</label>
                <div id="centerIdContainer"></div>
            </div>
            <div class="form-group">
                <label>Item *</label>
                <div id="outgoingItemIdContainer"></div>
            </div>
            <div class="form-group">
                <label>Quantity Requested *</label>
                <input type="number" id="qtyRequested" value="${stock.Qty_Requested}" min="1" required>
            </div>
            <div class="form-group">
                <label>Quantity Issued *</label>
                <input type="number" id="qtyIssued" value="${stock.Qty_Issued}" min="0" required>
            </div>
            <div class="form-group">
                <label>Officer Name *</label>
                <input type="text" id="officerName" value="${escapeHtml(stock.Officer_Name)}" required>
            </div>
            <div class="form-group">
                <label>Officer NIC *</label>
                <input type="text" id="officerNIC" value="${escapeHtml(stock.Officer_NIC)}" required>
            </div>
            <div class="form-group">
                <label>Remarks</label>
                <textarea id="remarks">${escapeHtml(stock.Remarks || '')}</textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Dispatch</button>
            </div>
        </form>
    `;

    showModal('Edit Dispatch Record', modalBody);

    // Load all items and centers for editing (not just active ones)
    Promise.all([
        window.api.items.getAll(),
        window.api.centers.getAll()
    ]).then(([items, centers]) => {
        const itemOptions = items.map(i => ({ 
            value: i.Item_ID.toString(), 
            text: `${i.Item_Name} (${i.Unit_Measure})${i.Status === 'Inactive' ? ' [Inactive]' : ''}` 
        }));

        const centerOptions = centers.map(c => ({ 
            value: c.Center_ID.toString(), 
            text: `${c.Center_Name} - ${c.District}${c.Status === 'Inactive' ? ' [Inactive]' : ''}` 
        }));

        const itemSelect = new SearchableSelect('outgoingItemIdContainer', itemOptions, 'Search items...');
        itemSelect.setValue(stock.Item_ID.toString());
        const centerSelect = new SearchableSelect('centerIdContainer', centerOptions, 'Search centers...');
        centerSelect.setValue(stock.Center_ID.toString());
        
        window.currentOutgoingItemSelect = itemSelect;
        window.currentCenterSelect = centerSelect;
    });

    document.getElementById('editOutgoingForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const itemId = window.currentOutgoingItemSelect ? window.currentOutgoingItemSelect.getValue() : '';
        const centerId = window.currentCenterSelect ? window.currentCenterSelect.getValue() : '';
        
        if (!itemId) {
            showNotification('Please select an item', 'error');
            return;
        }
        if (!centerId) {
            showNotification('Please select a center', 'error');
            return;
        }
        
        try {
            await window.api.outgoing.update(dispatchId, {
                Date_Issued: document.getElementById('dateIssued').value,
                Center_ID: parseInt(centerId),
                Item_ID: parseInt(itemId),
                Qty_Requested: parseInt(document.getElementById('qtyRequested').value),
                Qty_Issued: parseInt(document.getElementById('qtyIssued').value),
                Officer_Name: document.getElementById('officerName').value,
                Officer_NIC: document.getElementById('officerNIC').value,
                Remarks: document.getElementById('remarks').value || null
            });
            closeModal();
            loadOutgoingStock();
            showNotification('Dispatch record updated successfully', 'success');
        } catch (error) {
            showNotification('Failed to update dispatch record: ' + error.message, 'error');
        }
    });
}

async function deleteOutgoingStock(dispatchId) {
    if (!confirm('Are you sure you want to delete this dispatch record?')) {
        return;
    }
    try {
        await window.api.outgoing.delete(dispatchId);
        loadOutgoingStock();
        showNotification('Dispatch record deleted successfully', 'success');
    } catch (error) {
        showNotification('Failed to delete dispatch record: ' + error.message, 'error');
    }
}

// Database Import/Export
async function exportDatabase() {
    try {
        const result = await window.api.database.export();
        if (result.success) {
            showNotification('Database exported successfully', 'success');
        } else if (!result.canceled) {
            showNotification('Failed to export database', 'error');
        }
    } catch (error) {
        showNotification('Failed to export database: ' + error.message, 'error');
    }
}

async function importDatabase() {
    if (!confirm('Warning: Importing a database will replace all current data. Continue?')) {
        return;
    }

    try {
        const result = await window.api.database.import();
        if (result.success) {
            showNotification('Database imported successfully. Page will reload.', 'success');
        } else if (!result.canceled) {
            showNotification('Failed to import database', 'error');
        }
    } catch (error) {
        showNotification('Failed to import database: ' + error.message, 'error');
    }
}

// Modal Functions
function showModal(title, body) {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-body').innerHTML = body;
    document.getElementById('modal').classList.add('active');
}

function closeModal() {
    document.getElementById('modal').classList.remove('active');
}

// Utility Functions
function showNotification(message, type = 'info') {
    // Simple console notification for now
    // Can be enhanced with a toast notification system
    console.log(`[${type.toUpperCase()}] ${message}`);
    alert(message);
}

function formatDate(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-GB');
}

function getCurrentDate() {
    return new Date().toISOString().split('T')[0];
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Searchable Select Component
class SearchableSelect {
    constructor(containerId, options, placeholder = 'Search...') {
        this.containerId = containerId;
        this.options = options;
        this.placeholder = placeholder;
        this.selectedValue = '';
        this.selectedText = '';
        this.render();
    }

    render() {
        const container = document.getElementById(this.containerId);
        if (!container) return;

        container.innerHTML = `
            <div class="searchable-select">
                <input 
                    type="text" 
                    class="searchable-select-input" 
                    placeholder="${this.placeholder}"
                    autocomplete="off"
                />
                <div class="searchable-select-dropdown"></div>
            </div>
        `;

        this.input = container.querySelector('.searchable-select-input');
        this.dropdown = container.querySelector('.searchable-select-dropdown');

        this.input.addEventListener('focus', () => this.showDropdown());
        this.input.addEventListener('input', (e) => this.filterOptions(e.target.value));
        this.input.addEventListener('blur', () => {
            setTimeout(() => this.hideDropdown(), 200);
        });

        document.addEventListener('click', (e) => {
            if (!container.contains(e.target)) {
                this.hideDropdown();
            }
        });
    }

    showDropdown() {
        this.renderOptions(this.options);
        this.dropdown.classList.add('active');
    }

    hideDropdown() {
        this.dropdown.classList.remove('active');
    }

    filterOptions(searchTerm) {
        const filtered = this.options.filter(opt => 
            opt.text.toLowerCase().includes(searchTerm.toLowerCase())
        );
        this.renderOptions(filtered);
    }

    renderOptions(options) {
        if (options.length === 0) {
            this.dropdown.innerHTML = '<div class="searchable-select-option no-results">No results found</div>';
            return;
        }

        this.dropdown.innerHTML = options.map(opt => `
            <div class="searchable-select-option ${opt.value === this.selectedValue ? 'selected' : ''}" 
                 data-value="${opt.value}">
                ${escapeHtml(opt.text)}
            </div>
        `).join('');

        this.dropdown.querySelectorAll('.searchable-select-option').forEach(option => {
            if (!option.classList.contains('no-results')) {
                option.addEventListener('click', () => {
                    this.selectOption(option.dataset.value, option.textContent.trim());
                });
            }
        });
    }

    selectOption(value, text) {
        this.selectedValue = value;
        this.selectedText = text;
        this.input.value = text;
        this.hideDropdown();
    }

    getValue() {
        return this.selectedValue;
    }

    setValue(value) {
        const option = this.options.find(opt => opt.value === value);
        if (option) {
            this.selectedValue = value;
            this.selectedText = option.text;
            this.input.value = option.text;
        }
    }

    updateOptions(newOptions) {
        this.options = newOptions;
        if (this.dropdown.classList.contains('active')) {
            this.renderOptions(newOptions);
        }
    }

    reset() {
        this.selectedValue = '';
        this.selectedText = '';
        this.input.value = '';
    }
}

// Reports Functions
async function loadReportsPage() {
    try {
        // Load items for selection
        const items = await window.api.items.getActive();
        currentData.items = items;

        // Populate items list
        const itemsList = document.getElementById('itemsList');
        itemsList.innerHTML = items.map(item => `
            <label style="display: block; padding: 5px;">
                <input type="checkbox" class="item-checkbox" value="${item.Item_ID}">
                ${escapeHtml(item.Item_Name)} (${escapeHtml(item.Unit_Measure)})
            </label>
        `).join('');

        // Setup event listeners
        setupReportsEventListeners();
    } catch (error) {
        console.error('Error loading reports page:', error);
        showNotification('Failed to load reports page', 'error');
    }
}

function setupReportsEventListeners() {
    const reportType = document.getElementById('reportType');
    const selectAllItems = document.getElementById('selectAllItems');
    const itemSelectionSection = document.getElementById('itemSelectionSection');
    const dateRangeSection = document.getElementById('dateRangeSection');
    const generateReportBtn = document.getElementById('generateReportBtn');

    // Report type change
    reportType.addEventListener('change', () => {
        const type = reportType.value;
        if (type === 'current-stock') {
            dateRangeSection.style.display = 'none';
        } else {
            dateRangeSection.style.display = 'block';
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            const monthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            document.getElementById('reportDateFrom').value = monthAgo;
            document.getElementById('reportDateTo').value = today;
        }
    });

    // Select all items checkbox
    selectAllItems.addEventListener('change', () => {
        const isChecked = selectAllItems.checked;
        itemSelectionSection.style.display = isChecked ? 'none' : 'block';
        
        if (!isChecked) {
            // Check all items by default when opening
            document.querySelectorAll('.item-checkbox').forEach(cb => cb.checked = true);
        }
    });

    // Generate report button
    generateReportBtn.addEventListener('click', generateReport);
}

async function generateReport() {
    try {
        const reportType = document.getElementById('reportType').value;
        const selectAllItems = document.getElementById('selectAllItems').checked;
        
        let selectedItemIds = null;
        if (!selectAllItems) {
            selectedItemIds = Array.from(document.querySelectorAll('.item-checkbox:checked'))
                .map(cb => parseInt(cb.value));
            
            if (selectedItemIds.length === 0) {
                showNotification('Please select at least one item', 'error');
                return;
            }
        }

        const dateFrom = document.getElementById('reportDateFrom').value;
        const dateTo = document.getElementById('reportDateTo').value;

        // Validate date range for time-based reports
        if (reportType !== 'current-stock') {
            if (!dateFrom || !dateTo) {
                showNotification('Please select date range', 'error');
                return;
            }
            if (dateFrom > dateTo) {
                showNotification('From date cannot be after To date', 'error');
                return;
            }
        }

        showNotification('Generating PDF report...', 'info');

        const result = await window.api.reports.generatePDF({
            reportType,
            selectedItemIds,
            dateFrom,
            dateTo
        });

        if (result.success) {
            showNotification('Report generated successfully! File saved to: ' + result.path, 'success');
        } else {
            showNotification('Failed to generate report: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error generating report:', error);
        showNotification('Failed to generate report', 'error');
    }
}
